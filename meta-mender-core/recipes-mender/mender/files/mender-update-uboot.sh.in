#!/bin/sh

source mender-utils

MENDER_STORAGE_DEVICE=@MENDER_STORAGE_DEVICE@
MENDER_INSTALL_DEVICE=@MENDER_INSTALL_DEVICE@

FW_ENV_FILE="/data/u-boot/fw_env.config"

if [ -n "${MENDER_INSTALL_DEVICE}" ]; then
    ROOT_DEVICE=$(read_root_device)

    # Check if we booted from the installation disk
    if [[ "${ROOT_DEVICE}" == *"${MENDER_INSTALL_DEVICE}"* ]]; then
        # Check if config still points to the storage disk
        if grep -q "${MENDER_STORAGE_DEVICE}" "${FW_ENV_FILE}"; then
            # Change partitions to match the device we booted from
            sed -i "s#${MENDER_STORAGE_DEVICE}#${MENDER_INSTALL_DEVICE}#g" "${FW_ENV_FILE}"
        fi
    fi
fi
