From fb6b79de9dad6ba68d03962e1311d2e6a30ccc53 Mon Sep 17 00:00:00 2001
From: Garrett Brown <garrett.brown@aclima.io>
Date: Fri, 29 May 2020 23:57:09 -0700
Subject: [PATCH 5/6] Allow installing to embedded storage

---
 include/env_mender.h | 50 +++++++++++++++++++++++++++++++++++++-------
 1 file changed, 43 insertions(+), 7 deletions(-)

diff --git a/include/env_mender.h b/include/env_mender.h
index 0605f6a9fa..4d1e4ae174 100644
--- a/include/env_mender.h
+++ b/include/env_mender.h
@@ -71,9 +71,11 @@
                                                                         \
     "mender_check_saveenv_canary=1\0"                                   \
                                                                         \
-    "mender_setup="                                                     \
-    "if test \"${mender_saveenv_canary}\" != \"1\"; then "              \
-    "setenv mender_saveenv_canary 1; "                                  \
+    "mender_boot_targets=" MENDER_UBOOT_STORAGE_TARGET " " MENDER_UBOOT_INSTALL_TARGET "\0" \
+                                                                        \
+    "mender_setup_" MENDER_UBOOT_STORAGE_TARGET "=" \
+    "if test \"${mender_saveenv_canary_" MENDER_UBOOT_STORAGE_TARGET "}\" != \"1\"; then "              \
+    "setenv mender_saveenv_canary_" MENDER_UBOOT_STORAGE_TARGET " 1; "                                  \
     "saveenv; "                                                         \
     "fi; "                                                              \
     "if test \"${mender_pre_setup_commands}\" != \"\"; "                \
@@ -101,6 +103,38 @@
     "if test \"${mender_post_setup_commands}\" != \"\"; "               \
     "then "                                                             \
     "run mender_post_setup_commands; "                                  \
+    "fi\0"                                                              \
+                                                                        \
+    "mender_setup_" MENDER_UBOOT_INSTALL_TARGET "=" \
+    "if test \"${mender_saveenv_canary_" MENDER_UBOOT_INSTALL_TARGET "}\" != \"1\"; then "              \
+    "setenv mender_saveenv_canary_" MENDER_UBOOT_INSTALL_TARGET " 1; "                                  \
+    "saveenv; "                                                         \
+    "fi; "                                                              \
+    "if test \"${mender_pre_setup_commands}\" != \"\"; "                \
+    "then "                                                             \
+    "run mender_pre_setup_commands; "                                   \
+    "fi; "                                                              \
+    "if test \"${mender_systemd_machine_id}\" != \"\"; "                \
+    "then "                                                             \
+    "setenv bootargs systemd.machine_id=${mender_systemd_machine_id} "  \
+    "${bootargs}; "                                                     \
+    "fi; "                                                              \
+    "setenv mender_kernel_root " MENDER_INSTALL_DEVICE_BASE "${mender_boot_part}; "    \
+    "if test ${mender_boot_part} = " __stringify(MENDER_ROOTFS_PART_A_NUMBER) "; "     \
+    "then "                                                                            \
+    "setenv mender_boot_part_name " MENDER_INSTALL_ROOTFS_PART_A_NAME "; "                     \
+    "else "                                                                             \
+    "setenv mender_boot_part_name " MENDER_INSTALL_ROOTFS_PART_B_NAME "; "                     \
+    "fi; "                                                                             \
+    "setenv mender_kernel_root_name ${mender_boot_part_name}; "         \
+    "setenv mender_uboot_root " MENDER_UBOOT_INSTALL_INTERFACE " " __stringify(MENDER_UBOOT_INSTALL_DEVICE) ":${mender_boot_part_hex}; " \
+    "setenv mender_uboot_root_name ${mender_boot_part_name}; "          \
+    "setenv expand_bootargs \"setenv bootargs \\\\\"${bootargs}\\\\\"\"; "              \
+    "run expand_bootargs; "                                             \
+    "setenv expand_bootargs; "                                          \
+    "if test \"${mender_post_setup_commands}\" != \"\"; "               \
+    "then "                                                             \
+    "run mender_post_setup_commands; "                                  \
     "fi\0"                                                              \
                                                                         \
     "mender_altbootcmd="                                                \
@@ -146,10 +180,12 @@
 #endif
 
 #define CONFIG_MENDER_BOOTCOMMAND                                       \
-    "run mender_setup; "                                                \
-    MENDER_BOOTARGS                                                     \
-    MENDER_LOAD_KERNEL_AND_FDT                                          \
-    "${mender_boot_kernel_type} ${kernel_addr_r} - ${fdt_addr_r}; "     \
+    "for target in ${mender_boot_targets}; do "                      \
+        "run mender_setup_${target}; "                                                \
+        MENDER_BOOTARGS                                                     \
+        MENDER_LOAD_KERNEL_AND_FDT                                          \
+        "${mender_boot_kernel_type} ${kernel_addr_r} - ${fdt_addr_r}; "     \
+    "done; " \
     "run mender_try_to_recover"
 
 #endif /* !MENDER_AUTO_PROBING */
-- 
2.20.1

